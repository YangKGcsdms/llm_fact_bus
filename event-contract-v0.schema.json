{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://fact-bus.local/schemas/event-contract-v0.schema.json",
  "title": "Fact Bus Event Contract v0",
  "description": "Unified event contract for all Fact Bus categories.",
  "type": "object",
  "required": [
    "schema_version",
    "event_id",
    "event_category",
    "event_name",
    "occurred_at",
    "trace_id",
    "producer",
    "subject",
    "payload"
  ],
  "properties": {
    "schema_version": {
      "type": "string",
      "pattern": "^[0-9]+\\.[0-9]+\\.[0-9]+$"
    },
    "sequence_number": {
      "type": "integer",
      "minimum": 1
    },
    "event_id": {
      "type": "string",
      "format": "uuid"
    },
    "event_category": {
      "type": "string",
      "enum": [
        "FACT_EVENT",
        "PROPOSAL_EVENT",
        "DECISION_EVENT",
        "EXECUTION_EVENT",
        "OBSERVATION_EVENT",
        "TOOL_CALL_EVENT",
        "TOOL_RESULT_EVENT",
        "AGENT_DIAGNOSTIC_EVENT"
      ]
    },
    "event_name": {
      "type": "string",
      "minLength": 1
    },
    "occurred_at": {
      "type": "string",
      "format": "date-time"
    },
    "trace_id": {
      "type": "string",
      "minLength": 1
    },
    "causation_id": {
      "type": ["string", "null"],
      "format": "uuid"
    },
    "producer": {
      "$ref": "#/$defs/producer"
    },
    "subject": {
      "$ref": "#/$defs/subject"
    },
    "payload": {
      "type": "object"
    }
  },
  "allOf": [
    {
      "if": { "properties": { "event_category": { "const": "FACT_EVENT" } } },
      "then": { "properties": { "payload": { "$ref": "#/$defs/factPayload" } } }
    },
    {
      "if": { "properties": { "event_category": { "const": "PROPOSAL_EVENT" } } },
      "then": { "properties": { "payload": { "$ref": "#/$defs/proposalPayload" } } }
    },
    {
      "if": { "properties": { "event_category": { "const": "DECISION_EVENT" } } },
      "then": { "properties": { "payload": { "$ref": "#/$defs/decisionPayload" } } }
    },
    {
      "if": { "properties": { "event_category": { "const": "EXECUTION_EVENT" } } },
      "then": { "properties": { "payload": { "$ref": "#/$defs/executionPayload" } } }
    },
    {
      "if": { "properties": { "event_category": { "const": "OBSERVATION_EVENT" } } },
      "then": { "properties": { "payload": { "$ref": "#/$defs/observationPayload" } } }
    },
    {
      "if": { "properties": { "event_category": { "const": "TOOL_CALL_EVENT" } } },
      "then": { "properties": { "payload": { "$ref": "#/$defs/toolCallPayload" } } }
    },
    {
      "if": { "properties": { "event_category": { "const": "TOOL_RESULT_EVENT" } } },
      "then": { "properties": { "payload": { "$ref": "#/$defs/toolResultPayload" } } }
    },
    {
      "if": { "properties": { "event_category": { "const": "AGENT_DIAGNOSTIC_EVENT" } } },
      "then": { "properties": { "payload": { "$ref": "#/$defs/diagnosticPayload" } } }
    }
  ],
  "$defs": {
    "producer": {
      "type": "object",
      "required": ["type", "id", "version"],
      "properties": {
        "type": {
          "type": "string",
          "enum": [
            "sensor",
            "api",
            "database_snapshot",
            "agent",
            "arbitrator",
            "executor",
            "system"
          ]
        },
        "id": { "type": "string", "minLength": 1 },
        "version": { "type": "string", "minLength": 1 }
      },
      "additionalProperties": false
    },
    "subject": {
      "type": "object",
      "required": ["type", "id"],
      "properties": {
        "type": { "type": "string", "minLength": 1 },
        "id": { "type": "string", "minLength": 1 }
      },
      "additionalProperties": false
    },
    "factPayload": {
      "type": "object",
      "required": ["facts", "observed_from"],
      "properties": {
        "facts": { "type": "object" },
        "observed_from": {
          "type": "string",
          "enum": ["db", "api", "webhook", "executor_feedback", "human_input", "system"]
        },
        "derivation_rule_id": { "type": "string", "minLength": 1 },
        "derivation_rule_version": { "type": "string", "minLength": 1 },
        "decision_id": { "type": "string", "minLength": 1 },
        "execution_id": { "type": "string", "minLength": 1 }
      },
      "if": {
        "properties": { "observed_from": { "const": "executor_feedback" } }
      },
      "then": {
        "required": ["facts", "observed_from", "derivation_rule_id", "derivation_rule_version", "decision_id", "execution_id"]
      },
      "additionalProperties": true
    },
    "proposalPayload": {
      "type": "object",
      "required": [
        "proposal_id",
        "proposed_action",
        "based_on_events",
        "risk_level",
        "cost_estimate",
        "priority",
        "max_fact_age_ms"
      ],
      "properties": {
        "proposal_id": { "type": "string", "minLength": 1 },
        "proposed_action": { "type": "object" },
        "based_on_events": {
          "type": "array",
          "minItems": 1,
          "items": { "type": "string", "format": "uuid" }
        },
        "max_fact_age_ms": { "type": "integer", "minimum": 1 },
        "projection_version": { "type": "integer", "minimum": 1 },
        "risk_level": {
          "type": "string",
          "enum": ["low", "medium", "high", "critical"]
        },
        "cost_estimate": { "type": "number" },
        "priority": { "type": "integer" }
      },
      "additionalProperties": true
    },
    "decisionPayload": {
      "type": "object",
      "required": [
        "decision_id",
        "decision_on_proposals",
        "outcome",
        "policy_id",
        "policy_version",
        "reason_code"
      ],
      "properties": {
        "decision_id": { "type": "string", "minLength": 1 },
        "decision_on_proposals": {
          "type": "array",
          "minItems": 1,
          "items": { "type": "string", "minLength": 1 }
        },
        "outcome": { "type": "string", "enum": ["approved", "rejected"] },
        "policy_id": { "type": "string", "minLength": 1 },
        "policy_version": { "type": "string", "minLength": 1 },
        "reason_code": { "type": "string", "minLength": 1 },
        "conflict_with_proposal_ids": {
          "type": "array",
          "items": { "type": "string", "minLength": 1 }
        },
        "active_policy_ids": {
          "type": "array",
          "items": { "type": "string", "minLength": 1 }
        },
        "retry_hint": {
          "type": "object",
          "properties": {
            "missing_fact_keys": {
              "type": "array",
              "items": { "type": "string", "minLength": 1 }
            },
            "required_trust_tier": {
              "type": "string",
              "enum": ["tier_1", "tier_2", "tier_3"]
            },
            "preferred_sources": {
              "type": "array",
              "items": { "type": "string", "minLength": 1 }
            },
            "max_observation_age_ms": {
              "type": "integer",
              "minimum": 1
            }
          },
          "additionalProperties": true
        }
      },
      "if": {
        "properties": { "outcome": { "const": "rejected" } }
      },
      "then": {
        "required": [
          "decision_id",
          "decision_on_proposals",
          "outcome",
          "policy_id",
          "policy_version",
          "reason_code",
          "retry_hint"
        ]
      },
      "additionalProperties": true
    },
    "executionPayload": {
      "type": "object",
      "required": ["decision_event_id", "execution_id", "status", "executor"],
      "properties": {
        "decision_event_id": { "type": "string", "format": "uuid" },
        "execution_id": { "type": "string", "minLength": 1 },
        "status": {
          "type": "string",
          "enum": ["success", "failed", "timeout", "partial"]
        },
        "executor": { "type": "string", "minLength": 1 },
        "external_reference": { "type": "string" },
        "error_code": { "type": "string" },
        "error_message": { "type": "string" }
      },
      "additionalProperties": true
    },
    "observationPayload": {
      "type": "object",
      "required": ["source_tool", "evidence_ref", "confidence"],
      "properties": {
        "source_tool": { "type": "string", "minLength": 1 },
        "evidence_ref": { "type": "string", "minLength": 1 },
        "extracted_fields": { "type": "object" },
        "freshness": { "type": "string", "minLength": 1 },
        "confidence": { "type": "number", "minimum": 0, "maximum": 1 }
      },
      "additionalProperties": true
    },
    "toolCallPayload": {
      "type": "object",
      "required": ["tool_name", "caller_role", "args_hash", "started_at"],
      "properties": {
        "tool_name": { "type": "string", "minLength": 1 },
        "caller_role": { "type": "string", "minLength": 1 },
        "args_hash": { "type": "string", "minLength": 1 },
        "started_at": { "type": "string", "format": "date-time" }
      },
      "additionalProperties": true
    },
    "toolResultPayload": {
      "type": "object",
      "required": ["tool_name", "status", "result_hash"],
      "properties": {
        "tool_name": { "type": "string", "minLength": 1 },
        "status": { "type": "string", "enum": ["success", "failed"] },
        "result_hash": { "type": "string", "minLength": 1 },
        "evidence_ref": { "type": "string", "minLength": 1 },
        "error_code": { "type": "string" },
        "error_message": { "type": "string" }
      },
      "additionalProperties": true
    },
    "diagnosticPayload": {
      "type": "object",
      "required": ["diagnostic_type", "state_version"],
      "properties": {
        "diagnostic_type": { "type": "string", "minLength": 1 },
        "state_version": { "type": "string", "minLength": 1 },
        "graph_node": { "type": "string", "minLength": 1 },
        "input_event_ids": {
          "type": "array",
          "items": { "type": "string", "format": "uuid" }
        },
        "output_event_ids": {
          "type": "array",
          "items": { "type": "string", "format": "uuid" }
        },
        "transition_reason_code": { "type": "string", "minLength": 1 }
      },
      "additionalProperties": true
    }
  },
  "additionalProperties": false
}
